<!doctype HTML>
<html>
	<head>
		<meta charset="utf-8"/>
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
		<meta name="_csrf" th:content="${_csrf.token}"/>
		<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
		<title>ETCHAPEDIA_Test</title>
		<link rel="stylesheet" type="text/css" th:href="@{/header.css}"/>
	</head>
	<body>
		<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
		<div th:replace="~{header :: headerFragment}"></div>
		<th:block layout:fragment="content"></th:block>
		<script th:src="@{/header.js}"></script>
		
		<script>
			// 코멘트 팝업
			document.addEventListener("DOMContentLoaded", () => {
				window.showCommentPopup = function() {
			    const popup = document.getElementById("comment-popup");
			    if (popup) popup.style.display = "flex";
				console.log(popup.style.display);
			  };
			
			  window.closeCommentPopup = function() {
			    const popup = document.getElementById("comment-popup");
			    if (popup) popup.style.display = "none";
			  };
			});
			
		</script>
		
		<script th:inline="javascript">
		    // 장바구니
		    window.addToCart = function(bookId) {
		        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
		        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
		        const cartCountElement = document.getElementById('cart-item-count');

		        fetch('/cart/add', {
		            method: 'POST',
		            headers: {
		                'Content-Type': 'application/json',
		                [csrfHeader]: csrfToken
		            },
		            body: JSON.stringify({ bookIdx: bookId })
		        })
		        .then(response => {
		            if (!response.ok) {
		                throw new Error('Network response was not ok');
		            }
		            return response.json();
		        })
		        .then(data => {
		            if (data.success) {
		                alert('장바구니에 담았습니다!');
		                if (cartCountElement) {
		                    let currentCount = parseInt(cartCountElement.textContent) || 0;
		                    cartCountElement.textContent = currentCount + 1;
		                }
		            } else {
		                alert('장바구니 담기에 실패했습니다: ' + data.message);
		            }
		        })
		        .catch(error => {
		            console.error('Error:', error);
		            alert('장바구니 담기 중 오류가 발생했습니다.');
		        });
		    }

		    // 결제하기
		    window.addAndCheckout = function(bookId) {
		        alert('결제 페이지로 이동합니다!');
		        window.location.href = '/cart';
		    }

		    // 코멘트 팝업 열기/닫기
		    window.showCommentPopup = function() {
		        const popup = document.getElementById("comment-popup");
		        if (popup) popup.style.display = "flex";
		    }

		    window.closeCommentPopup = function() {
		        const popup = document.getElementById("comment-popup");
		        if (popup) popup.style.display = "none";
		    }

		    // 저장 버튼 이벤트 연결
		    document.addEventListener("DOMContentLoaded", () => {
		        const saveBtn = document.querySelector(".save-btn");
		        const textarea = document.querySelector("#comment-popup textarea");
		        const charCount = document.querySelector(".char-count");
		        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
		        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

		        if (textarea) {
		            // 글자 수 카운트
		            textarea.addEventListener("input", () => {
		                charCount.textContent = `${textarea.value.length}/10000`;
		            });
		        }

		        if (saveBtn) {
		            saveBtn.addEventListener("click", () => {
		                const content = textarea.value.trim();
		                if (content.length === 0) {
		                    alert("내용을 입력해주세요!");
		                    return;
		                }

		                fetch("/comments", {
		                    method: "POST",
		                    headers: {
		                        "Content-Type": "application/json",
		                        [csrfHeader]: csrfToken
		                    },
		                    body: JSON.stringify({
		                        content: content,
								bookIdx: document.querySelector("main.main-content")?.dataset.bookId
		                    })
		                })
		                .then(res => res.json())
		                .then(data => {
		                    if (data.success) {
		                        // 새 코멘트 DOM에 추가
		                        appendComment(data.comment);
		                        textarea.value = "";
		                        charCount.textContent = "0/10000";
		                        closeCommentPopup();
		                    } else {
		                        alert("저장 실패: " + data.message);
		                    }
		                })
		                .catch(err => {
		                    console.error("Error:", err);
		                    alert("저장 중 오류 발생");
		                });
		            });
		        }
		    });

		    // 코멘트 작성
		    function appendComment(comment) {
		        const grid = document.querySelector(".comments-grid");
		        const div = document.createElement("div");
		        div.classList.add("comment-item");
		        div.innerHTML = `
		            <div class="comment-header">
		                <img src="https://via.placeholder.com/30" alt="프로필 이미지">
		                <span class="user-name">${comment.user.name}</span>
		            </div>
		            <p class="comment-content">${comment.content}</p>
		            <div class="comment-actions">
		                <div class="action-buttons">
		                    <button class="like-btn"><i class="fa-regular fa-thumbs-up"></i>좋아요</button>
		                    <button class="reply-btn" onclick="showCommentPopup()"><i class="fa-regular fa-comment"></i>댓글</button>
		                </div>
		            </div>
		        `;
		        if (grid) {
		            grid.prepend(div); // 최근에 작성된 코멘트 가장 먼저 보이게 하기
		        }
		    }
		</script>
		
		<script>
			// 관심없어요
			document.addEventListener("DOMContentLoaded", () => {
			    const btn = document.getElementById("disinterest-button");
			    const icon = btn.querySelector("i");

			    btn.addEventListener("click", () => {
			        const bookId = btn.dataset.bookId;
			        const wasHated = btn.dataset.isHated === "true"; 

			        // 1️. UI 먼저 토글
			        toggleIconUI(icon, btn, !wasHated);

			        // 2️. 서버 요청
			        toggleDisinterest(bookId, !wasHated)
			            .catch(err => {
			                console.error(err);
			                alert("처리 중 오류가 발생했습니다.");

			                // 3️. 실패 시 UI 롤백
			                toggleIconUI(icon, btn, wasHated);
			            });
			    });
			});

			function toggleIconUI(icon, btn, isHated) {
			    if (isHated) {
			        icon.classList.remove("fa-regular");
			        icon.classList.add("fa-solid");
			        btn.dataset.isHated = "true";
			    } else {
			        icon.classList.remove("fa-solid");
			        icon.classList.add("fa-regular");
			        btn.dataset.isHated = "false";
			    }
			}

			function toggleDisinterest(bookId, isHated) {
			    const token = document.querySelector("meta[name='_csrf']").content;
			    const header = document.querySelector("meta[name='_csrf_header']").content;

			    return fetch(`/book/disinterest`, {
			        method: "POST",
			        headers: {
			            "Content-Type": "application/json",
			            [header]: token
			        },
			        body: JSON.stringify({ bookId, isHated })
			    })
			    .then(res => {
			        if (!res.ok) throw new Error("관심없어요 반영 실패");
			        return res.json();
			    });
			}
		</script>
	</body>
</html>